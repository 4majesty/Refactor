package com.successfactors.cdp.service.mentoring.jam.impl;

import javax.inject.Inject;

import org.jboss.seam.annotations.In;

import com.successfactors.cdp.bean.mentoring.jam.JamGroupInviteJobPayload;
import com.successfactors.cdp.service.mentoring.jam.ScheduleProgramJamGroupInviteJob;
import com.successfactors.cdp.service.scheduledjob.MentoringProgramJamGroupInviteJobType;
import com.successfactors.cdp.service.util.mentoring.MentoringJobUtil;
import com.successfactors.jobscheduler.JobSchedulerException;
import com.successfactors.jobscheduler.bean.JobScheduleRequestEO;
import com.successfactors.jobscheduler.service.JobScheduleFacade;
import com.successfactors.legacy.util.Serializer;
import com.successfactors.logging.api.LogManager;
import com.successfactors.logging.api.Logger;
import com.successfactors.platform.bean.ParamBean;
import com.successfactors.sca.ServiceApplicationException;
import com.successfactors.sca.ServiceCommandImpl;
import com.successfactors.sca.config.Service;

@Service
public class ScheduleProgramJamGroupInviteJobImpl 
  implements ServiceCommandImpl<Void, ScheduleProgramJamGroupInviteJob> {

  private static Logger log = LogManager.getLogger();

  @Inject
  @In
  private ParamBean params;

  @Override
  public Void execute(ScheduleProgramJamGroupInviteJob cmd) throws ServiceApplicationException {
    JobScheduleRequestEO newRequest = MentoringJobUtil.createOneTimeJobRequest(params, MentoringProgramJamGroupInviteJobType.NAME, 
        new MentoringProgramJamGroupInviteJobType(), getPayload(cmd));

    try {
      JobScheduleFacade.scheduleAndRunJob(newRequest);
    } catch (JobSchedulerException e) {
      throw new ServiceApplicationException("Failed to schedule jam group invite job:" + newRequest.getJobName(), e);
    }

    return null;
  }

   private byte[] getPayload(ScheduleProgramJamGroupInviteJob cmd) {
     return serialize(new JamGroupInviteJobPayload(cmd.getProgramId(),cmd.getParticipants()));
   }

   private byte[] serialize(JamGroupInviteJobPayload payload) {
     Serializer ser = Serializer.getInstanceFor(JamGroupInviteJobPayload.class);
     return ser.serialize(payload);
   }
}